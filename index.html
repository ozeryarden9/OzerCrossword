<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>תשבץ משפחתי | Family Crossword</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- TensorFlow.js and KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.4"></script>
    <script src="hebrew-knn-classifier.js"></script>
    
    <!-- OpenCV.js for grid detection -->
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="console.log('OpenCV.js loaded');"></script>
    
    <!-- Continuous Handwriting Recognition (uses Azure) -->
    <script src="handwriting.js?v=13"></script>
</head>
<body>
    <!-- Error Notifications Container -->
    <div id="error-notifications"></div>
    
    <!-- Connection Status -->
    <div id="connection-status" class="offline-banner hidden">
        <span class="status-icon">⚠️</span>
        <span class="status-text">אין חיבור לאינטרנט - השינויים יישמרו כשהחיבור יחזור</span>
    </div>

    <!-- Main Container -->
    <div id="app">
        <!-- Theme Toggle -->
        <button id="theme-toggle" class="theme-toggle" title="החלף ערכת נושא">
            <span class="theme-icon">🌙</span>
        </button>

        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <div class="home-container">
                <div class="home-header">
                    <h1 class="main-title">תשבץ משפחתי</h1>
                    <p class="subtitle">פתרו תשבצים ביחד, בזמן אמת</p>
                </div>

                <div class="action-cards">
                    <div class="action-card create-card" id="create-room-btn">
                        <div class="card-icon">➕</div>
                        <h2>צור חדר חדש</h2>
                        <p>העלה תשבץ והתחל לפתור עם המשפחה</p>
                    </div>

                    <div class="action-card join-card" id="join-room-btn">
                        <div class="card-icon">🚪</div>
                        <h2>הצטרף לחדר</h2>
                        <p>הזן קוד חדר והצטרף לתשבץ קיים</p>
                    </div>
                </div>

                <div class="settings-card" id="settings-btn">
                    <div class="card-icon">⚙️</div>
                    <h2>הגדרות רשת</h2>
                    <p>הגדר את גודל וצורת הרשת</p>
                </div>

                <div class="history-card" id="history-btn">
                    <div class="card-icon">📚</div>
                    <h2>תשבצים קודמים</h2>
                    <p>חזור לתשבצים שפתחת בעבר</p>
                </div>
            </div>
        </div>

        <!-- Room History Screen -->
        <div id="history-screen" class="screen">
            <div class="screen-container">
                <button class="back-btn" id="back-from-history">← חזור</button>
                
                <h1 class="screen-title">תשבצים קודמים</h1>
                
                <div id="history-list" class="history-list">
                    <div class="empty-history">
                        <div class="empty-icon">📭</div>
                        <p>אין תשבצים קודמים</p>
                        <p class="empty-hint">תשבצים שתיצור יופיעו כאן</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Room Screen -->
        <div id="create-screen" class="screen">
            <div class="screen-container">
                <button class="back-btn" id="back-from-create">← חזור</button>
                
                <h1 class="screen-title">צור חדר חדש</h1>
                
                <div class="detection-info">
                    <p>📸 העלה תמונת תשבץ - הרשת תזוהה אוטומטית!</p>
                    <p class="detection-note">הרשת חייבת להיות 11×11 תאים</p>
                </div>

                <div class="room-name-section">
                    <label for="room-name-input" class="input-label">שם החדר (אופציונלי)</label>
                    <input 
                        type="text" 
                        id="room-name-input" 
                        class="room-name-input" 
                        placeholder='לדוגמה: "תשבץ שבת 5.1.26"'
                        maxlength="50">
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">📸</div>
                        <p class="upload-text">גרור תמונת תשבץ או לחץ להעלאה</p>
                        <p class="upload-hint">PNG, JPG עד 5MB</p>
                        <input type="file" id="crossword-upload" accept="image/png,image/jpeg,image/jpg" hidden>
                    </div>
                    
                    <div id="preview-container" class="preview-container hidden">
                        <img id="crossword-preview" alt="תצוגה מקדימה">
                        <canvas id="detection-canvas" class="detection-canvas"></canvas>
                        <div id="grid-edit-overlay" class="grid-edit-overlay hidden"></div>
                        <button class="remove-image-btn" id="remove-image">✕</button>
                        <div id="detection-status" class="detection-status hidden">
                            <div class="status-icon">🔍</div>
                            <div class="status-text">מזהה רשת...</div>
                        </div>
                        <div id="edit-controls" class="edit-controls hidden">
                            <div class="edit-hint">👆 לחץ על תא כדי להחליף בין שחור/לבן</div>
                            <button class="primary-btn" id="confirm-grid">✅ נראה טוב - המשך</button>
                        </div>
                    </div>
                </div>

                <button class="primary-btn" id="create-room-submit" disabled>
                    צור חדר ותתחיל לפתור
                </button>
            </div>
        </div>

        <!-- Join Room Screen -->
        <div id="join-screen" class="screen">
            <div class="screen-container">
                <button class="back-btn" id="back-from-join">← חזור</button>
                
                <h1 class="screen-title">הצטרף לחדר</h1>
                
                <div class="join-form">
                    <label for="room-code-input" class="input-label">קוד חדר</label>
                    <input 
                        type="text" 
                        id="room-code-input" 
                        class="room-code-input" 
                        placeholder="הזן 6 תווים"
                        maxlength="6"
                        autocomplete="off">
                    
                    <button class="primary-btn" id="join-room-submit">
                        הצטרף לחדר
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="screen-container-wide">
                <button class="back-btn" id="back-from-settings">← חזור</button>
                
                <h1 class="screen-title">הגדרות רשת</h1>
                
                <div class="settings-instructions">
                    <p>📐 הגדר את הרשת פעם אחת - היא תשמש לכל התשבצים</p>
                </div>

                <div class="settings-form">
                    <div class="settings-grid-layout">
                        <div class="settings-controls">
                            <div class="settings-instructions-box">
                                <h3>איך להגדיר את הרשת:</h3>
                                <ol>
                                    <li>העלה תמונת תשבץ לדוגמה</li>
                                    <li>הזן את גודל הרשת (למשל 11×11)</li>
                                    <li>גרור והזז את הריבוע הכתום</li>
                                    <li>שנה גודל בפינות</li>
                                    <li>שמור!</li>
                                </ol>
                            </div>

                            <div class="setting-group">
                                <label for="grid-size" class="input-label">גודל רשת (שורות × עמודות)</label>
                                <div class="grid-size-input">
                                    <input 
                                        type="number" 
                                        id="grid-rows" 
                                        class="settings-input-inline" 
                                        min="5" 
                                        max="25" 
                                        value="15"
                                        placeholder="שורות">
                                    <span class="multiply-sign">×</span>
                                    <input 
                                        type="number" 
                                        id="grid-cols" 
                                        class="settings-input-inline" 
                                        min="5" 
                                        max="25" 
                                        value="15"
                                        placeholder="עמודות">
                                </div>
                            </div>

                            <div class="setting-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="show-grid-lines" checked>
                                    <span>הצג קווי רשת</span>
                                </label>
                            </div>

                            <button class="secondary-btn" id="upload-template-image">
                                📸 העלה תמונת תשבץ לדוגמה
                            </button>
                            <input type="file" id="template-image-upload" accept="image/png,image/jpeg,image/jpg" hidden>

                            <div class="control-hints">
                                <p><strong>💡 טיפים:</strong></p>
                                <p>• גרור את הריבוע למיקום הנכון</p>
                                <p>• משוך את הפינות לשינוי גודל</p>
                                <p>• הריבוע הכתום = איפה הרשת תופיע</p>
                            </div>

                            <button class="primary-btn" id="save-settings">
                                💾 שמור הגדרות
                            </button>

                            <button class="secondary-btn" id="reset-grid">
                                🔄 איפוס לברירת מחדל
                            </button>

                            <div class="settings-section-divider"></div>

                            <div class="setting-group">
                                <h3 class="settings-section-title">🖊️ זיהוי כתב יד (MyScript)</h3>
                                <p class="settings-hint">זיהוי כתב יד עברי עם MyScript iink - מותאם במיוחד ל-Apple Pencil</p>
                                
                                <label class="input-label">MyScript Application Key</label>
                                <input 
                                    type="text" 
                                    id="myscript-app-key" 
                                    class="settings-input" 
                                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

                                <label class="input-label">MyScript HMAC Key</label>
                                <input 
                                    type="password" 
                                    id="myscript-hmac-key" 
                                    class="settings-input" 
                                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

                                <button class="secondary-btn" id="test-myscript">
                                    🧪 בדוק חיבור
                                </button>

                                <div class="settings-hint">
                                    <strong>💡 איך להשיג:</strong><br>
                                    1. לך ל-<a href="https://developer.myscript.com" target="_blank">MyScript Developer Portal</a><br>
                                    2. צור חשבון חינם (Sign Up)<br>
                                    3. צור Application חדשה<br>
                                    4. בחר "iink" SDK<br>
                                    5. העתק Application Key ו-HMAC Key<br>
                                    מכסה חינמית: 2,000 זיהויים/חודש
                                </div>

                                <div class="handwriting-test-area">
                                    <h4>🧪 בדוק זיהוי כתב יד</h4>
                                    <p class="test-hint"><strong>טיפ:</strong> כתוב את האות <strong>גדולה וברורה</strong> באמצע המלבן</p>
                                    
                                    <div class="test-canvas-container">
                                        <canvas id="test-handwriting-canvas" class="test-canvas"></canvas>
                                        <button class="clear-test-btn" id="clear-test-canvas">🗑️</button>
                                    </div>
                                    
                                    <button class="primary-btn" id="recognize-test">
                                        ✨ זהה אות
                                    </button>
                                    
                                    <div id="test-result" class="test-result hidden">
                                        <div class="result-label">תוצאה:</div>
                                        <div id="test-result-text" class="result-text"></div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-preview">
                            <div class="preview-label">תצוגה מקדימה</div>
                            <div id="grid-preview-container" class="grid-preview-container">
                                <div class="preview-placeholder">
                                    <div class="placeholder-icon">📸</div>
                                    <p>העלה תמונת תשבץ לדוגמה</p>
                                </div>
                                <img id="grid-preview-image" src="" alt="">
                                <div id="grid-overlay-draggable" class="grid-overlay-draggable">
                                    <div class="resize-handle top-left"></div>
                                    <div class="resize-handle top-right"></div>
                                    <div class="resize-handle bottom-left"></div>
                                    <div class="resize-handle bottom-right"></div>
                                    <div class="grid-preview-overlay" id="grid-preview-overlay"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                        <div class="settings-preview">
                            <div class="preview-label">תצוגה מקדימה</div>
                            <div id="grid-preview-container" class="grid-preview-container">
                                <img id="grid-preview-image" src="" alt="העלה תמונה לדוגמה">
                                <div id="grid-preview-overlay" class="grid-preview-overlay"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crossword Room Screen -->
        <div id="room-screen" class="screen">
            <div class="room-header">
                <button class="back-btn" id="back-from-room">← עזוב חדר</button>
                <div class="room-info">
                    <h2 class="room-title">חדר: <span id="room-id-display"></span></h2>
                    <button class="copy-btn" id="copy-room-id" title="העתק קוד חדר">
                        📋
                    </button>
                </div>
                <div class="participants">
                    <span class="participants-icon">👥</span>
                    <span id="participants-count">1</span>
                </div>
                <button class="handwriting-toggle-btn" id="toggle-handwriting" title="Toggle handwriting mode">
                    🖊️
                </button>
                <button class="handwriting-toggle-btn" id="toggle-recognition" title="Toggle auto-recognition">
                    🤖
                </button>
                <button class="handwriting-toggle-btn" id="eraser-btn" title="Clear all drawings">
                    🧹
                </button>
            </div>

            <div class="room-content">
                <div class="crossword-area">
                    <!-- Crossword image background -->
                    <div id="crossword-image-container" class="crossword-image-container">
                        <img id="crossword-image" alt="תשבץ">
                        <canvas id="handwriting-canvas" class="handwriting-canvas"></canvas>
                    </div>
                    
                    <!-- Interactive grid overlay -->
                    <div id="crossword-grid" class="crossword-grid"></div>
                </div>

                <!-- Hebrew Keyboard -->
                <div id="hebrew-keyboard" class="hebrew-keyboard hidden">
                    <div class="keyboard-header">
                        <span id="keyboard-cell-info"></span>
                        <button class="keyboard-close" id="keyboard-close">✕</button>
                    </div>
                    <div class="keyboard-keys">
                        <!-- Hebrew letters -->
                        <button class="key" data-char="א">א</button>
                        <button class="key" data-char="ב">ב</button>
                        <button class="key" data-char="ג">ג</button>
                        <button class="key" data-char="ד">ד</button>
                        <button class="key" data-char="ה">ה</button>
                        <button class="key" data-char="ו">ו</button>
                        <button class="key" data-char="ז">ז</button>
                        <button class="key" data-char="ח">ח</button>
                        <button class="key" data-char="ט">ט</button>
                        <button class="key" data-char="י">י</button>
                        <button class="key" data-char="כ">כ</button>
                        <button class="key" data-char="ך">ך</button>
                        <button class="key" data-char="ל">ל</button>
                        <button class="key" data-char="מ">מ</button>
                        <button class="key" data-char="ם">ם</button>
                        <button class="key" data-char="נ">נ</button>
                        <button class="key" data-char="ן">ן</button>
                        <button class="key" data-char="ס">ס</button>
                        <button class="key" data-char="ע">ע</button>
                        <button class="key" data-char="פ">פ</button>
                        <button class="key" data-char="ף">ף</button>
                        <button class="key" data-char="צ">צ</button>
                        <button class="key" data-char="ץ">ץ</button>
                        <button class="key" data-char="ק">ק</button>
                        <button class="key" data-char="ר">ר</button>
                        <button class="key" data-char="ש">ש</button>
                        <button class="key" data-char="ת">ת</button>
                        <button class="key key-backspace" data-action="backspace">⌫</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDxhn494a_2j3aFrjPQ0z5S5xEmEfLLi64",
            authDomain: "ozercrossword.firebaseapp.com",
            databaseURL: "https://ozercrossword-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ozercrossword",
            storageBucket: "ozercrossword.firebasestorage.app",
            messagingSenderId: "312555492459",
            appId: "1:312555492459:web:3f16af08cb24ceba280d2e",
            measurementId: "G-6EL0HBMWY2"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <script src="firebase-app.js?v=23"></script>
</body>
</html>
